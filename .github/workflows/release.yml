name: Release Executables

on:
  push:
    tags:
      - 'v*.*.*'  # ä»…å½“æ¨é€ç¬¦åˆ v1.2.3 æ ¼å¼çš„ tag æ—¶è§¦å‘

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11"]  # å¯æ ¹æ®é¡¹ç›®è°ƒæ•´

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install project dependencies
        run: pip install -r requirements.txt

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Find and build .spec file (Linux/Mac)
        if: matrix.os != 'windows-latest'
        shell: bash
        id: build-unix
        run: |
          # æŸ¥æ‰¾æ ¹ç›®å½•ä¸‹å”¯ä¸€çš„ .spec æ–‡ä»¶ï¼ˆLinux / macOSï¼‰
          SPEC=$(find . -maxdepth 1 -name "*.spec" | head -n1)
          if [[ -z "$SPEC" ]]; then
            echo "âŒ Error: No .spec file found in repository root!"
            exit 1
          fi
          echo "âœ… Found spec file: $SPEC"
          pyinstaller "$SPEC"

      - name: Find and build .spec file (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        id: build-windows
        run: |
          # æŸ¥æ‰¾æ ¹ç›®å½•ä¸‹å”¯ä¸€çš„ .spec æ–‡ä»¶ï¼ˆWindows PowerShellï¼‰
          $specObj = Get-ChildItem -Path . -Filter '*.spec' -File | Select-Object -First 1
          if (-not $specObj) {
            Write-Error "âŒ Error: No .spec file found in repository root!"
            exit 1
          }
          $spec = $specObj.Name
          Write-Host "âœ… Found spec file: $spec"
          pyinstaller $spec

      - name: show dist contents
        run: ls -la dist/

      - name: Upload raw dist directory as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}
          path: dist/
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»æ˜¾å¼æˆæƒæ‰èƒ½åˆ›å»º release

    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Add platform suffixes and collect release assets
        run: |
          mkdir -p release-assets

          for artifact_dir in artifacts/dist-*; do
            if [[ ! -d "$artifact_dir" ]]; then
              continue
            fi

            # æå–å¹³å°åï¼šdist-ubuntu-latest â†’ ubuntu-latest
            platform=${artifact_dir#artifacts/dist-}

            echo "ğŸ“¦ Processing platform: $platform"

            # éå† dist ç›®å½•ä¸­çš„æ¯ä¸€ä¸ªæ–‡ä»¶
            for file in "$artifact_dir"/*; do
              if [[ ! -f "$file" ]]; then
                continue
              fi

              basename_file=$(basename "$file")
              name_without_ext="${basename_file%.*}"
              ext="${basename_file##*.}"

              # ç‰¹æ®Šå¤„ç†ï¼šWindows åŸæœ¬å°±æ˜¯ .exeï¼Œå…¶ä»–å¹³å°æ— æ‰©å±•å
              if [[ "$platform" == "windows-latest" ]]; then
                new_name="${name_without_ext}-windows.exe"
              elif [[ "$platform" == "macos-latest" ]]; then
                new_name="${name_without_ext}-macos"
              else  # ubuntu-latest etc.
                new_name="${name_without_ext}-linux"
              fi

              echo "  â†’ Renaming $basename_file â†’ $new_name"
              cp "$file" "release-assets/$new_name"
            done
          done

      - name: List final release assets
        run: |
          echo "ğŸ“ Final assets to release:"
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}